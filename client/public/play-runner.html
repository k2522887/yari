<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>

  <body>
    <script>
      async function decompressFromBase64(base64String) {
        function base64ToBytes(base64) {
          const binString = atob(base64);
          return Uint8Array.from(binString, (m) => m.codePointAt(0));
        }
        const bytes = base64ToBytes(base64String);

        const decompressionStream = new DecompressionStream("deflate-raw");

        const decompressedStream = new Response(
          new Blob([bytes]).stream().pipeThrough(decompressionStream)
        ).arrayBuffer();

        return new TextDecoder().decode(await decompressedStream);
      }

      const url = new URL(window.location);
      const state = url.searchParams.get("state");
      if ("serviceWorker" in navigator && state) {
        navigator.serviceWorker
          .register("/play-runner.js", { scope: "/" })
          .then((registration) => {
            console.log("Service worker registration succeeded:", registration);
          })
          .catch((error) => {
            console.error(`Service worker registration failed: ${error}`);
          });
        navigator.serviceWorker.ready.then(async (registration) => {
          const data = JSON.parse((await decompressFromBase64(state)) || "{}");
          console.log(`tying to load code: ${JSON.stringify(data)}`);
          if (
            window.parent !== window ||
            window.confirm(`load code? ${JSON.stringify(data)}`)
          ) {
            console.log(`loading code: ${JSON.stringify(data)}`);
            let sp = new URLSearchParams(window.location.search);
            sp.set("id", globalThis.crypto.randomUUID());
            window.location.search = sp.toString();
          } else {
            registration.unregister().then((success) => {
              console.log("unregistered", success);
            });
          }
        });
      }
    </script>
  </body>
</html>
